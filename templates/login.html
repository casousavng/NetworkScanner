{% extends "base.html" %}
{% block body %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h4 class="text-center">NetworkScanner - Login</h4>
                </div>
                <div class="card-body">
                    <!-- Tabs para alternar entre sistemas -->
                    <ul class="nav nav-tabs" id="loginTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <a class="nav-link active" id="new-login-tab" data-bs-toggle="tab" href="#new-login" 
                               role="tab" aria-controls="new-login" aria-selected="true">Login Seguro</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" id="old-login-tab" data-bs-toggle="tab" href="#old-login" 
                               role="tab" aria-controls="old-login" aria-selected="false">Login Clássico</a>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="loginTabsContent">
                        <!-- Novo sistema em duas etapas -->
                        <div class="tab-pane fade show active" id="new-login" role="tabpanel" aria-labelledby="new-login-tab">
                            
                            <!-- Etapa 1: Username e Password -->
                            <div id="step1" class="login-step">
                                <form method="POST" action="/request_token" class="mt-3">
                                    <h5 class="mb-3">Etapa 1: Credenciais</h5>
                                    
                                    <div class="form-group mb-3">
                                        <label for="username">Username:</label>
                                        <input type="text" name="username" id="username" class="form-control" 
                                               placeholder="Seu nome de utilizador" required>
                                    </div>
                                    
                                    <div class="form-group mb-3">
                                        <label for="password">Password:</label>
                                        <input type="password" name="password" id="password" class="form-control" 
                                               placeholder="Sua password" required>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-envelope"></i> Solicitar Token por Email
                                    </button>
                                    
                                    <small class="form-text text-muted mt-2">
                                        Após validar as credenciais, será enviado um token para o seu email registado.
                                    </small>
                                </form>
                            </div>
                            
                            <!-- Etapa 2: Token (aparece após step 1) -->
                            <div id="step2" class="login-step" style="display: none;">
                                <form method="POST" action="/login_with_token" class="mt-3">
                                    <h5 class="mb-3">Etapa 2: Token de Acesso</h5>
                                    
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i>
                                        Token enviado para: <span id="user-email"></span>
                                    </div>
                                    
                                    <input type="hidden" name="username" id="hidden-username">
                                    
                                    <div class="form-group mb-3">
                                        <label for="token">Token de Acesso:</label>
                                        <input type="text" name="token" id="token" class="form-control" 
                                               placeholder="Insira o token recebido por email" required>
                                        <small class="form-text text-muted">
                                            Verifique a sua caixa de email e insira o token recebido.
                                        </small>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <button type="button" class="btn btn-secondary w-100" onclick="goBackToStep1()">
                                                <i class="fas fa-arrow-left"></i> Voltar
                                            </button>
                                        </div>
                                        <div class="col-md-6">
                                            <button type="submit" class="btn btn-success w-100">
                                                <i class="fas fa-sign-in-alt"></i> Fazer Login
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <!-- Sistema antigo (fallback) -->
                        <div class="tab-pane fade" id="old-login" role="tabpanel" aria-labelledby="old-login-tab">
                            <form method="POST" class="mt-3">
                                <div class="form-group mb-3">
                                    <label for="username">Utilizador:</label>
                                    <input type="text" name="username" class="form-control" 
                                           placeholder="Nome de utilizador">
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label for="password">Password:</label>
                                    <input type="password" name="password" class="form-control" 
                                           placeholder="Password">
                                </div>
                                
                                <button type="submit" class="btn btn-secondary w-100">Login Clássico</button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Informações do sistema -->
                    <div class="mt-4 text-muted text-center">
                        <small>
                            <strong>Rede:</strong> {{ network.addr if network else 'N/A' }}/{{ network.netmask if network else 'N/A' }}<br>
                            <strong>Gateway:</strong> {{ router_ip if router_ip else 'N/A' }}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Controle das etapas de login
function goBackToStep1() {
    document.getElementById('step1').style.display = 'block';
    document.getElementById('step2').style.display = 'none';
    document.getElementById('username').focus();
}

function showStep2(username, email) {
    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = 'block';
    document.getElementById('hidden-username').value = username;
    document.getElementById('user-email').textContent = email;
    document.getElementById('token').focus();
}

// Auto-focar no primeiro campo do tab ativo
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('#loginTabs a[data-bs-toggle="tab"]');
    tabs.forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(event) {
            const targetTab = event.target.getAttribute('href');
            if (targetTab === '#new-login') {
                const usernameInput = document.getElementById('username');
                if (usernameInput) {
                    usernameInput.focus();
                }
            } else if (targetTab === '#old-login') {
                const usernameInput = document.querySelector('#old-login input[type="text"]');
                if (usernameInput) {
                    usernameInput.focus();
                }
            }
        });
    });
    
    // Focar no primeiro campo ao carregar
    const usernameInput = document.getElementById('username');
    if (usernameInput) {
        usernameInput.focus();
    }

    // Verificar se deve mostrar a etapa 2 (se veio de redirect)
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('step') === '2') {
        const username = urlParams.get('username');
        const email = urlParams.get('email');
        if (username && email) {
            showStep2(username, email);
        }
    }
});
</script>
{% endblock %}


