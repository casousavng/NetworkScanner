{% extends "base.html" %}
{% block body %}
<div class="container mt-4">
  <h3>Novo Scan</h3>
  <hr>
  <p><strong>Escolha o tipo de scan que pretende realizar:</strong></p>

  <form method="POST" action="{{ url_for('do_scan') }}" id="scanForm">
    <div class="form-group mb-3">
      <p><em>A ordem de scan determina a forma como os IPs são verificados e o tempo de execução do scan.</em></p>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="scan_type" id="scanAll" value="all" checked>
        <label class="form-check-label" for="scanAll">Toda a Rede</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="scan_type" id="scanRange" value="range">
        <label class="form-check-label" for="scanRange">Intervalo de IPs</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="scan_type" id="scanSpecific" value="specific">
        <label class="form-check-label" for="scanSpecific">IP Específico</label>
      </div>
    </div>

    <div class="form-group mb-3" id="ipInputGroup" style="display: none;">
      <label for="ip_range">Endereço IP:</label>
      <input type="text" class="form-control" id="ip_range" name="ip_range" placeholder="Ex: 192.168.1.10">
    </div>

    <div class="form-group mb-3" id="ipRangeGroup" style="display: none;">
      <label for="ip_start">Intervalo de IPs:</label>
      <div class="input-group">
        <input type="text" class="form-control" id="ip_start" name="ip_start" placeholder="IP inicial (Ex: 192.168.1.10)">
        <span class="input-group-text">até</span>
        <input type="text" class="form-control" id="ip_end" name="ip_end" placeholder="IP final (Ex: 192.168.1.20)">
      </div>
    </div>

    <hr>
    <div class="mb-3">
      <p><strong>Escolha as portas que pretende testar:</strong></p>
      <p><em>Separe um intervalo de portas com um traço (-) ou portas especificas com virgulas (,); deixe em branco para pesquisar todas as portas (1-65535). Fará com que o scan demore mais tempo.</em></p>
      <label class="form-label">Range de portas:</label>
      <input type="text" name="port_range" class="form-control" maxlength="20" placeholder="Ex: 20-80 ou 22,80,443">
    </div>
    <hr>

    <button type="submit" class="btn btn-primary" id="submitBtn">
      <span id="submitText">Iniciar Scan</span>
      <span id="spinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
    </button>
    <div id="scanMessage" class="alert alert-warning mt-3 d-none"></div>
    <div id="scanMessage2" class="alert alert-danger mt-3 d-none"></div>
  </form>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const scanAllRadio = document.getElementById('scanAll');
    const scanSpecificRadio = document.getElementById('scanSpecific');
    const scanRangeRadio = document.getElementById('scanRange');
    const ipInputGroup = document.getElementById('ipInputGroup');
    const ipRangeGroup = document.getElementById('ipRangeGroup');
    const form = document.getElementById('scanForm');
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    const spinner = document.getElementById('spinner');
    const scanMessage = document.getElementById('scanMessage');
    const scanMessage2 = document.getElementById('scanMessage2');

  // Mostra/oculta input IP conforme opção
scanAllRadio.addEventListener('change', () => {
  ipInputGroup.style.display = 'none';
  ipRangeGroup.style.display = 'none';
  document.getElementById('ip_range').disabled = true;
  document.getElementById('ip_start').disabled = true;
  document.getElementById('ip_end').disabled = true;
});

scanSpecificRadio.addEventListener('change', () => {
  ipInputGroup.style.display = 'block';
  ipRangeGroup.style.display = 'none';
  document.getElementById('ip_range').disabled = false;
  document.getElementById('ip_start').disabled = true;
  document.getElementById('ip_end').disabled = true;
});

scanRangeRadio.addEventListener('change', () => {
  ipInputGroup.style.display = 'none';
  ipRangeGroup.style.display = 'block';
  document.getElementById('ip_range').disabled = true;
  document.getElementById('ip_start').disabled = false;
  document.getElementById('ip_end').disabled = false;
});
  // Quando submeter o formulário
  form.addEventListener('submit', function (event) {
    // Evita múltiplos envios
    submitBtn.disabled = true;
    
    // Tenta desativar os botões na navbar
    setTimeout(function() {
      const btnIds = [
        'scan', 'mapa', 'dispositivos', 'historico',
        'assistenteIA', 'ajuda', 'sobre', 'reportarProblema'
      ];
      btnIds.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
          btn.disabled = true;
          btn.classList.add('nav-btn-disabled');

        }
        // Desativa os radio buttons de tipo de scan
        const radios = document.querySelectorAll('input[name="scan_type"]');
        radios.forEach(radio => {
          radio.disabled = true;
        });
        document.querySelector('input[name="port_range"]').disabled = true;
        document.getElementById('ip_range').disabled = true;
        document.getElementById('ip_start').disabled = true;
        document.getElementById('ip_end').disabled = true;
      });
    }, 0);

    // Mostra spinner
    spinner.classList.remove('d-none');

    // Altera texto do botão
    submitText.textContent = 'A realizar scan...';

    scanMessage.classList.remove('d-none');
    scanMessage.textContent = 'O scan pode demorar alguns minutos. Será redirecionado para o mapa de rede quando terminar.';
    scanMessage2.classList.remove('d-none');
    scanMessage2.textContent = 'POR FAVOR NÃO FECHE OU FAÇA REFRESH NA PÁGINA DURANTE O SCAN! ';
  });
  }); // fecha DOMContentLoaded

</script>
{% endblock %}